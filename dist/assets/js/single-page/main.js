"use strict";function getRootElementFontSize(){return parseFloat(getComputedStyle(document.documentElement).fontSize)}var paintingHeight=2048,paintingScale=.5,paintingDisplayHeight=paintingHeight*paintingScale,paintingThumbHeight=512,paintingThumbScale=paintingDisplayHeight/paintingThumbHeight,paintingBlurHeight=32,paintingBlurScale=paintingDisplayHeight/paintingBlurHeight,paintingMargin=160,paintingCascadeLength=944,paintingUIStaticWidthPadding=32,paintingUIWidthPadding=32,zoomTourMargin=32,tourBoundsWidth=3,translateExtentBuffer=256,translateExtentTourBuffer=1024,minScale=.05,maxScale=2,durationShort=500,durationMed=750,durationLong=1e3,durationVLong=2e3,defaultEase=d3.easeCubicInOut,loaded=!1;d3.json("assets/json/paintings.json",function(t){function n(t){return new Promise(function(n,a){var i=new Image;i.onload=function(){n(i)},i.onerror=i.onabort=function(){a(t)},i.src=t})}function a(){for(var t=[],a=0;a<L.length;a++)t.push(n(L[a].painting.thumbUrl));return Promise.all(t)}function i(){var t=C.getBoundingClientRect();R=t.width,A=t.height,Q.showSplash&&s()}function e(){W.attr("transform",d3.event.transform),V.attr("transform","scale("+1/d3.event.transform.k+") translate(16, 0)"),O.attr("stroke-width",tourBoundsWidth/d3.event.transform.k)}function r(t,n,a){function i(){return d3.zoomIdentity.scale(d).translate(l,p)}var e=d3.transition().duration(durationLong).ease(defaultEase),r=this.getBBox(),o=r.width,c=r.height,s=r.x+r.width/2,u=r.y+r.height/2,d=Math.max(minScale,Math.min(maxScale,1/Math.max(o/R,c/A))),l=R/2/d-s,p=A/2/d-u;N.transition(e).call(q.transform,i)}function o(t,n,a){function i(){return d3.zoomIdentity.scale(d).translate(g,v)}var e=d3.transition().duration(durationLong).ease(defaultEase),r=this.getBBox(),o=d3.select(this).select(".base-container").node().getBBox(),c=d3.select(this).select(".painting-ui-container").node().getBBox(),s=o.width,u=o.height,d=Math.max(minScale,Math.min(maxScale,1/(u/A))),l=r.x+s+c.width/d+2.5*paintingUIWidthPadding,p=r.y+u/2,g=R/d-l,v=A/2/d-p;N.transition(e).call(q.transform,i)}function c(t,n,a){function i(){return d3.zoomIdentity.scale(l).translate(p,g)}var e=d3.transition().duration(durationLong).ease(defaultEase),r=this.parentNode.parentNode.parentNode.getBBox(),o=this.getBBox(),c=o.width,s=o.height,u=o.x+o.width/2+r.x,d=o.y+o.height/2+r.y,l=Math.max(minScale,Math.min(maxScale,1/Math.max(c/(R-2*zoomTourMargin),s/(A-2*zoomTourMargin)))),p=R/2/l-u,g=A/2/l-d;N.transition(e).call(q.transform,i)}function s(){if(loaded)if(void 0===Q.activePainting)r.bind(N.select("#frame-splash").node())();else{var t=f().getBBox(),n=d3.select(f()).select(".base-container").node().getBBox();void 0===Q.activeTour?q.translateExtent([[t.x,t.y],[t.x+t.width,t.y+n.height]]):q.translateExtent([[t.x-translateExtentTourBuffer,t.y-translateExtentTourBuffer],[t.x+t.width+translateExtentTourBuffer,t.y+t.height+translateExtentTourBuffer]]);void 0===Q.activeTour?translateExtentBuffer:translateExtentTourBuffer;void 0===Q.activeTour?o.bind(f())():c.bind(d3.select(m()).select(".painting-step.step-"+Q.activeTour.step).node())()}}function u(t){return void 0!==Q.activePainting&&t.painting.key===Q.activePainting.data.painting.key}function d(t){return void 0!==Q.activePainting&&t.painting.key!==Q.activePainting.data.painting.key}function l(t){return void 0!==Q.activeTour&&t.painting.key===Q.activePainting.data.painting.key}function p(t,n){return void 0!==Q.activeTour&&Q.activeTour.step===n}function g(t,n){return"translate("+n*paintingCascadeLength+","+n*(paintingDisplayHeight+paintingMargin)+")"}function v(t,n){return"translate("+-d3.select(this).select(".base-container").node().getBBox().width+","+n*(paintingDisplayHeight+paintingMargin)+")"}function h(t,n){return Q.showSplash?g.bind(this)(t,n):v.bind(this)(t,n)}function f(){if(void 0===Q.activePainting.node&&(Q.activePainting.node=W.select("#"+Q.activePainting.data.painting.key).node(),null===Q.activePainting.node))throw void 0===Q.activePainting.node,"getActivePaintingNode(): Could not find active painting node";return Q.activePainting.node}function m(){if(void 0===Q.activeTour.node&&(Q.activeTour.node=d3.select(f()).select(".painting-tour-container").node(),null===Q.activeTour.node))throw void 0===Q.activeTour.node,"getActiveTourNode: Could not find active tour node";return Q.activeTour.node}function x(){var t=Url.parseQuery(),n=t.activePainting;if(n){var a=_.find(L,function(t){return t.painting.key===n});if(void 0!==a){Q.showSplash=!1,Q.activePainting={data:a};var i=t.activeTour;if(i){var e=_.find(Q.activePainting.data.tours,function(t){return t.key===i});if(void 0!==e){Q.activeTour={data:e,step:0};var r=parseInt(t.step,10);!isNaN(r)&&r>=0&&r<Q.activeTour.data.steps.length&&(Q.activeTour.step=r)}}}}}function T(){void 0!==Q.activePainting?(Url.updateSearchParam("activePainting",Q.activePainting.data.painting.key),void 0!==Q.activeTour?(Url.updateSearchParam("activeTour",Q.activeTour.data.key),Url.updateSearchParam("step",Q.activeTour.step)):(Url.updateSearchParam("activeTour"),Url.updateSearchParam("step"))):(Url.updateSearchParam("activePainting"),Url.updateSearchParam("activeTour"),Url.updateSearchParam("step"))}function y(){loaded&&(b(),S())}function b(){var t=d3.transition().duration(durationVLong).ease(defaultEase);j=F.selectAll(".painting").data(L,function(t,n){return t.painting.key}),j.select(".painting-container").transition(t).attr("transform",h),k(j.select(".painting-tour-container"));var n=j.enter().append("g").attr("class","painting transform-container").attr("id",function(t){return t.painting.key}),a=n.append("g").attr("class","painting-container"),i=a.append("g").attr("class","base-container"),e=(i.append("rect").attr("class","painting-baserect").attr("id",function(t){return"baserect-"+t.painting.key}).attr("height",paintingDisplayHeight).attr("width",function(t){return t.painting.aspectRatio*paintingDisplayHeight}),i.append("image").attr("class","painting-thumb").attr("xlink:href",function(t){return t.painting.thumbUrl}).attr("width",paintingThumbHeight).attr("height",function(t){return t.painting.aspectRatio*paintingThumbHeight}).attr("transform",function(t){return"scale("+paintingThumbScale+") translate("+t.painting.aspectRatio*paintingThumbHeight+",0) rotate (90)"}),i.append("image").attr("class","painting-base").attr("xlink:href",function(t){return t.painting.fullUrl}).attr("width",paintingHeight).attr("height",function(t){return t.painting.aspectRatio*paintingHeight}).attr("transform",function(t){return"scale("+paintingScale+") translate("+t.painting.aspectRatio*paintingHeight+",0) rotate (90)"}),i.append("g").attr("class","painting-blur").append("image").attr("class","painting-blur-base").attr("xlink:href",function(t){return t.painting.blurredUrl}).attr("width",paintingBlurHeight).attr("height",function(t){return t.painting.aspectRatio*paintingBlurHeight}).attr("transform",function(t){return"scale("+paintingBlurScale+") translate("+t.painting.aspectRatio*paintingBlurHeight+",0) rotate (90)"}),a.append("g").attr("class","painting-tour-container")),r=a.append("g").attr("class","painting-right-edge").attr("transform",function(t){return"translate("+t.painting.aspectRatio*paintingDisplayHeight+", 0)"}).append("g").attr("class","painting-ui-position-container");P(r),k(e),a.attr("transform",h);var o=j.exit();o.remove();var c=n.merge(j);c.classed("inactive",d).classed("active",u);var s=c.select(".painting-blur").classed("active",function(t){return u(t)&&l(t)});Q.showSplash?c.select(".painting-container").on("click",null):void 0===Q.activePainting?c.select(".painting-container").on("click",B):(c.select(".painting-container").on("click",null),void 0!==Q.activeTour&&s.attr("mask","url(#cutout-mask-"+Q.activeTour.step+")"))}function P(t){var n=t.append("g").attr("class","painting-ui-container");V=W.selectAll(".painting-ui-container");var a=n.append("text").attr("class","info prevent-zoom").attr("y",2.5*I);a.append("tspan").attr("class","name header prevent-zoom reset-cursor").attr("x",0).text(function(t){return t.painting.name}),a.append("tspan").attr("class","painter prevent-zoom reset-cursor").attr("x",0).attr("dy",3*I).text(function(t){return"Attributed to "+t.painting.painter});var i=n.append("g").attr("class","painting-ui-contents-container"),e=6.5,r=e+.5,o=2;i.append("line").attr("class","divider").attr("x1",0).attr("y1",e*I).attr("x2",350).attr("y2",e*I);var c=i.append("g").attr("class","contents-entry visual-tour-button prevent-zoom").on("click",H,!0);c.append("text").text("Visual Analysis").attr("class","prevent-zoom").attr("x",0).attr("y",(r+1*o)*I)}function k(t){t.classed("active",l);var n=t.selectAll(".painting-step").data(function(t){return l(t)?Q.activeTour.data.steps:[]});if(n.exit().remove(),void 0!==Q.activePainting&&void 0!==Q.activeTour){var a=n.enter().append("g").attr("class",function(t,n){return"painting-step step-"+n}),i=a.append("defs").attr("class","tour-def"),e=i.append("mask").attr("id",function(t,n){return"cutout-mask-"+n}),r=(i.append("g").attr("class","bounds-container").attr("id",function(t,n){return"bounds-container-"+n}),a.append("use").attr("xlink:href",function(t,n){return"#bounds-container-"+n}).attr("class","bounds-display-container"),a.merge(n)),o=r.select(".bounds-container").selectAll("rect").data(function(t,n){return p(t,n)?t.bounds:[]}),c=o.enter().append("rect").attr("id",function(t,n){return"bounds-"+n}).attr("x",function(t){return t.x}).attr("y",function(t){return t.y}).attr("height",function(t){return t.height}).attr("width",function(t){return t.width}).attr("stroke-width",3).attr("class","painting-bounds").classed("outlined",function(t,n){return t.framed===!0});c.transition().duration(1).on("end",function(){this.classList.add("active")}),o.exit().transition().duration(durationShort).on("start",function(){this.classList.remove("active")}).remove(),e.append("use").attr("xlink:href","#baserect-"+Q.activePainting.data.painting.key).attr("fill","white"),e.append("use").attr("xlink:href",function(t,n){return"#bounds-container-"+n}).attr("fill","black")}O=W.selectAll("rect.outlined")}function S(){var t=d3.select("#menu-painters").selectAll("li").data(L);t.enter().append("li").append("a").text(function(t){return t.painting.painter}).merge(t).classed("active",u).on("click",B.bind(void 0)),d3.select(".overlay").classed("active",function(){return void 0!==Q.activeTour}),void 0!==Q.activeTour&&(d3.select("#tour-header").html(function(){return decodeURI(Q.activeTour.data.steps[Q.activeTour.step].header)}),d3.select("#tour-text").html(function(){return decodeURI(Q.activeTour.data.steps[Q.activeTour.step].html)})),d3.select(".intro-page").classed("active",function(){return Q.showSplash})}function w(){Q.activePainting=void 0,Q.activeTour=void 0,Q.showSplash=!1,y(),s(),T()}function B(t,n,a){Q.activePainting={data:t,i:n,node:void 0!==this?this.parentNode:void 0},Q.activeTour=void 0,Q.showSplash=!1,y(),s(),T()}function H(){void 0!==Q.activePainting&&E(Q.activePainting.data.tours.visualTour,0)}function E(t,n){Q.activeTour={data:t,step:n},y(),s(),T()}function z(){void 0!==Q.activeTour&&Q.activeTour.step<Q.activeTour.data.steps.length-1&&(Q.activeTour.step++,y(),s(),T())}function U(){void 0!==Q.activeTour&&Q.activeTour.step>0&&(Q.activeTour.step--,y(),s(),T())}function M(t){t=t||window.event,37===t.keyCode?(U(),t.preventDefault()):39===t.keyCode&&(z(),t.preventDefault())}var R,A,L=t.mainPaintings,I=getRootElementFontSize(),D=d3.select(".svg-container"),C=D.node(),N=d3.select(".svg-fullscreen"),W=N.select(".root");d3.select(window).on("resize",i);var j,F=W.select(".paintings"),V=W.selectAll(".painting-ui-container"),O=W.selectAll("rect.outlined"),Q={activePainting:void 0,activeTour:void 0,showSplash:!0};document.addEventListener("keydown",M),d3.select("#button-begin").on("click",w,!0),d3.select("#menu-home").on("click",w,!0),d3.select("#button-next").on("click",function(){z()},!0),d3.select("#button-prev").on("click",function(){U()},!0);var q=d3.zoom().scaleExtent([minScale,maxScale]).on("zoom",e).filter(function(){var t=void 0!==Q.activePainting&&!event.button&&!event.target.classList.contains("prevent-zoom");return t});N.call(q),x(),a().then(function(t){for(var n=0;n<t.length;n++)L[n].painting.aspectRatio=t[n].height/t[n].width;loaded=!0,y(),s()}),i()});