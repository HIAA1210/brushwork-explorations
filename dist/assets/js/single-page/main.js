"use strict";var paintingHeight=2048,paintingScale=.5,paintingDisplayHeight=paintingHeight*paintingScale,paintingThumbHeight=512,paintingThumbScale=paintingDisplayHeight/paintingThumbHeight,paintingMargin=160,paintingCascadeLength=944,minScale=.05,maxScale=2,durationShort=500,durationMed=750,durationLong=1e3,durationVLong=2e3,defaultEase=d3.easeCubicInOut,loaded=!1;d3.json("assets/json/paintings.json",function(t){function n(t){return new Promise(function(n,i){var e=new Image;e.onload=function(){n(e)},e.onerror=e.onabort=function(){i(t)},e.src=t})}function i(){for(var t=[],i=0;i<B.length;i++)t.push(n(B[i].painting.thumbUrl));return Promise.all(t)}function e(){var t=E.getBoundingClientRect();H=t.width,M=t.height}function a(){z.attr("transform",d3.event.transform)}function o(t,n,i){function e(){return d3.zoomIdentity.scale(d).translate(l,g)}var a=d3.transition().duration(durationLong).ease(defaultEase),o=this.parentNode.getBBox(),r=o.width,c=o.height,s=o.x+o.width/2,u=o.y+o.height/2,d=Math.max(minScale,Math.min(maxScale,1/Math.max(r/H,c/M))),l=H/2/d-s,g=M/2/d-u;I.transition(a).call(C.transform,e)}function r(t,n,i){function e(){return d3.zoomIdentity.scale(u).translate(d,l)}var a=d3.transition().duration(durationLong).ease(defaultEase),o=this.parentNode.getBBox(),r=(o.width,o.height),c=o.x+o.width,s=o.y+o.height/2,u=Math.max(minScale,Math.min(maxScale,1/(r/M))),d=H/u-c,l=M/2/u-s;I.transition(a).call(C.transform,e)}function c(t,n,i){function e(){return d3.zoomIdentity.scale(l).translate(g,p)}var a=d3.transition().duration(durationLong).ease(defaultEase),o=this.parentNode.parentNode.parentNode.getBBox(),r=this.getBBox(),c=r.width,s=r.height,u=r.x+r.width/2+o.x,d=r.y+r.height/2+o.y,l=Math.max(minScale,Math.min(maxScale,1/Math.max(c/H,s/M))),g=H/2/l-u,p=M/2/l-d;I.transition(a).call(C.transform,e)}function s(){loaded&&(void 0===N.activePainting?o.bind(I.select("#frame-splash").node())():void 0===N.activeTour?r.bind(N.activePainting.node)():c.bind(d3.select(N.activeTour.node).select(".painting-step.step-"+N.activeTour.step).node())())}function u(t){return void 0!==N.activePainting&&t.painting.key!==N.activePainting.data.painting.key}function d(t){return void 0!==N.activeTour&&t.key===N.activeTour.key}function l(t,n){return void 0!==N.activeTour&&N.activeTour.step===n}function g(t,n){return"translate("+n*paintingCascadeLength+","+n*(paintingDisplayHeight+paintingMargin)+")"}function p(t,n){return"translate("+-this.getBBox().width+","+n*(paintingDisplayHeight+paintingMargin)+")"}function h(t,n){return N.showSplash?g.bind(this)(t,n):p.bind(this)(t,n)}function v(){loaded&&(f(),T())}function f(){var t=d3.transition().duration(durationVLong).ease(defaultEase);D=R.selectAll(".painting").data(B,function(t,n){return t.painting.key}),D.select(".painting-container").transition(t).attr("transform",h),m(D.select(".painting-tour-container"));var n=D.enter().append("g").attr("class","painting transform-container").attr("id",function(t){return t.painting.key}),i=n.append("g").attr("class","painting-container"),e=(i.append("image").attr("class","painting-base").attr("xlink:href",function(t){return t.painting.thumbUrl}).attr("height",paintingThumbHeight).attr("width",function(t){return t.painting.aspectRatio*paintingThumbHeight}).attr("transform","scale("+paintingThumbScale+")"),i.append("image").attr("class","painting-base").attr("xlink:href",function(t){return t.painting.fullUrl}).attr("height",paintingHeight).attr("width",function(t){return t.painting.aspectRatio*paintingHeight}).attr("transform","scale("+paintingScale+")"),i.append("g").attr("class","painting-tour-container"));m(e),i.attr("transform",h);var a=D.exit();a.remove();var o=n.merge(D);o.classed("inactive",u),N.showSplash||void 0!==N.activePainting?o.select(".painting-container").on("click",null):o.select(".painting-container").on("click",w)}function m(t){var n=t.selectAll("g").data(function(t){return d(t)?t.visualTour.steps:[]}),i=n.enter().append("g").attr("class",function(t,n){return"painting-step step-"+n});n.exit().remove();var e=i.merge(n),a=e.selectAll("rect").data(function(t,n){return l(t,n)?t.bounds:[]});a.enter().append("rect").attr("x",function(t){return t.x}).attr("y",function(t){return t.y}).attr("height",function(t){return t.height}).attr("width",function(t){return t.width}).classed("outlined",function(t,n){return t.framed===!0});a.exit().remove()}function T(){d3.select(".overlay").classed("active",function(){return void 0!==N.activeTour}),void 0!==N.activeTour&&(d3.select("#tour-header").html(function(){return decodeURI(N.activeTour.data.steps[N.activeTour.step].header)}),d3.select("#tour-text").html(function(){return decodeURI(N.activeTour.data.steps[N.activeTour.step].html)})),d3.select(".intro-page").classed("active",function(){return N.showSplash})}function x(){N.activePainting=void 0,N.activeTour=void 0,N.showSplash=!1,v(),s()}function w(t,n,i){N.activePainting={data:t,i:n,node:this},v(),s()}function y(){void 0!==N.activePainting&&b(N.activePainting.data.visualTour,0)}function b(t,n){N.activeTour={data:t,step:n,node:d3.select(N.activePainting.node).select(".painting-tour-container").node()},v(),s()}function S(){void 0!==N.activeTour&&N.activeTour.step<N.activeTour.data.steps.length-1&&(N.activeTour.step++,v(),s())}function k(){void 0!==N.activeTour&&N.activeTour.step>0&&(N.activeTour.step--,v(),s())}function P(t){t=t||window.event,37===t.keyCode?(k(),t.preventDefault()):39===t.keyCode&&(S(),t.preventDefault())}var H,M,B=t.mainPaintings,L=d3.select(".svg-container"),E=L.node(),I=d3.select(".svg-fullscreen"),z=I.select(".root");d3.select(window).on("resize",e);var C=d3.zoom().scaleExtent([minScale,maxScale]).on("zoom",a);I.call(C);var D,R=I.select(".paintings"),N={activePainting:void 0,activeTour:void 0,showSplash:!0};document.addEventListener("keydown",P),d3.select("#button-begin").on("click",x),d3.select("#menu-home").on("click",x),d3.select("#button-start-visual-analysis").on("click",function(){y()}),d3.select("#button-next").on("click",function(){S()}),d3.select("#button-prev").on("click",function(){k()}),i().then(function(t){for(var n=0;n<t.length;n++)B[n].painting.aspectRatio=t[n].width/t[n].height;loaded=!0,v(),s()}),e()});