"use strict";function getRootElementFontSize(){return parseFloat(getComputedStyle(document.documentElement).fontSize)}var paintingHeight=2048,paintingScale=.5,paintingDisplayHeight=paintingHeight*paintingScale,paintingThumbHeight=512,paintingThumbScale=paintingDisplayHeight/paintingThumbHeight,paintingBlurHeight=32,paintingBlurScale=paintingDisplayHeight/paintingBlurHeight,paintingMargin=160,paintingCascadeLength=944,paintingUIStaticWidthPadding=32,paintingUIWidthPadding=32,zoomTourMargin=32,tourBoundsWidth=3,translateExtentBuffer=256,translateExtentTourBuffer=1024,minScale=.05,maxScale=2,durationShort=500,durationMed=750,durationLong=1e3,durationVLong=2e3,defaultEase=d3.easeCubicInOut,loaded=!1;d3.json("assets/json/paintings.json",function(t,n){function e(t){switch(t.type){case"painting":return O[t.key];case"crop":return Q[t.key]}}function a(t,n){return new Promise(function(e,a){if(t.loaded)e();else{var i=new Image,r=new Image,o=void 0!==t.blurredUrl;if(i.onload=function(){t.aspectRatio=i.height/i.width,t.loaded=!0,e(),r.src=t.baseUrl},i.onerror=i.onabort=function(){console.error("failed to preload thumbnail",t),a(i)},r.onerror=r.onabort=function(){console.error("failed to preload base",t),a(i)},i.src=t.thumbUrl,o){var c=new Image;c.onerror=c.onabort=function(){console.error("failed to preload blurred",t),a(c)},c.src=t.blurredUrl}n||e()}})}function i(){for(var t=[],n=0;n<V.length;n++)t.push(a(V[n].painting,!0));return Promise.all(t)}function r(t){if(t.loaded)return Promise.resolve();for(var n=[],i=0;i<t.steps.length;i++){var r=t.steps[i];if(void 0!==r.objects)for(var o=r.objects.length,c=0;c<o;c++)"painting"!==r.objects[c].type&&"crop"!==r.objects[c].type||n.push(a(e(r.objects[c]),!0))}return Promise.all(n).then(function(){t.loaded=!0})}function o(t){if(t.loaded)return Promise.resolve();var n=[];if(void 0!==t.objects)for(var i=t.objects.length,r=0;r<i;r++)"painting"!==t.objects[r].type&&"crop"!==t.objects[r].type||n.push(a(e(t.objects[r]),!0));return Promise.all(n).then(function(){t.loaded=!0})}function c(){var t=J.getBoundingClientRect();C=t.width,W=t.height,F=document.getElementById("navbar").offsetHeight,nt.showSplash&&p()}function s(){X.attr("transform",d3.event.transform),$.attr("transform","scale("+1/d3.event.transform.k+") translate(16, 0)"),tt.attr("stroke-width",tourBoundsWidth/d3.event.transform.k)}function u(t,n,e){function a(){return d3.zoomIdentity.scale(d).translate(l,p)}var i=d3.transition().duration(durationLong).ease(defaultEase),r=this.getBBox(),o=r.width,c=r.height,s=r.x+r.width/2,u=r.y+r.height/2,d=Math.max(minScale,Math.min(maxScale,1/Math.max(o/C,c/W))),l=C/2/d-s,p=W/2/d-u;K.transition(i).call(et.transform,a)}function d(t,n,e){function a(){return d3.zoomIdentity.scale(d).translate(g,h)}var i=d3.transition().duration(durationLong).ease(defaultEase),r=this.getBBox(),o=d3.select(this).select(".base-container").node().getBBox(),c=d3.select(this).select(".painting-ui-container").node().getBBox(),s=o.width,u=o.height,d=Math.max(minScale,Math.min(maxScale,1/(u/W))),l=r.x+s+c.width/d+2.5*paintingUIWidthPadding,p=r.y+u/2,g=C/d-l,h=W/2/d-p;K.transition(i).call(et.transform,a)}function l(t,n,e){function a(){return d3.zoomIdentity.scale(l).translate(p,g)}var i=d3.transition().duration(durationLong).ease(defaultEase),r=this.parentNode.parentNode.parentNode.getBBox(),o=this.getBBox(),c=o.width,s=o.height,u=o.x+o.width/2+r.x,d=o.y+o.height/2+r.y,l=Math.max(minScale,Math.min(maxScale,1/Math.max(c/(C-2*zoomTourMargin),s/(W-F-2*zoomTourMargin)))),p=C/2/l-u,g=(W-F)/2/l-d;K.transition(i).call(et.transform,a)}function p(){if(loaded)if(void 0===nt.activePainting)u.bind(K.select("#frame-splash").node())();else{var t=x().getBBox(),n=d3.select(x()).select(".base-container").node().getBBox();void 0===nt.activeTour?et.translateExtent([[t.x,t.y],[t.x+t.width,t.y+n.height]]):et.translateExtent([[t.x-translateExtentTourBuffer,t.y-translateExtentTourBuffer],[t.x+t.width+translateExtentTourBuffer,t.y+t.height+translateExtentTourBuffer]]);void 0===nt.activeTour?translateExtentBuffer:translateExtentTourBuffer;void 0===nt.activeTour?d.bind(x())():l.bind(d3.select(y()).select(".painting-step.step-"+nt.activeTour.step).node())()}}function g(t){return void 0!==nt.activePainting&&t.painting.key===nt.activePainting.data.painting.key}function h(t){return void 0!==nt.activePainting&&t.painting.key!==nt.activePainting.data.painting.key}function v(t){return void 0!==nt.activeTour&&t.painting.key===nt.activePainting.data.painting.key}function f(t,n){return void 0!==nt.activeTour&&nt.activeTour.step===n}function m(t,n){return"translate("+n*paintingCascadeLength+","+n*(paintingDisplayHeight+paintingMargin)+")"}function b(t,n){return"translate("+-d3.select(this).select(".base-container").node().getBBox().width+","+n*(paintingDisplayHeight+paintingMargin)+")"}function T(t,n){return nt.showSplash?m.bind(this)(t,n):b.bind(this)(t,n)}function x(){if(void 0===nt.activePainting.node&&(nt.activePainting.node=X.select("#"+nt.activePainting.data.painting.key).node(),null===nt.activePainting.node))throw void 0===nt.activePainting.node,"getActivePaintingNode(): Could not find active painting node";return nt.activePainting.node}function y(){if(void 0===nt.activeTour.node&&(nt.activeTour.node=d3.select(x()).select(".painting-tour-container").node(),null===nt.activeTour.node))throw void 0===nt.activeTour.node,"getActiveTourNode: Could not find active tour node";return nt.activeTour.node}function P(){var t=Url.parseQuery(),n=t.activePainting;if(n){var e=_.find(V,function(t){return t.painting.key===n});if(void 0!==e){nt.showSplash=!1,nt.activePainting={data:e};var a=t.activeTour;if(a){var i=_.find(nt.activePainting.data.tours,function(t){return t.key===a});if(void 0!==i){nt.activeTour={data:i,step:0};var r=parseInt(t.step,10);!isNaN(r)&&r>=0&&r<nt.activeTour.data.steps.length&&(nt.activeTour.step=r)}else nt.activeTour=void 0}else nt.activeTour=void 0}else nt.activePainting=void 0,nt.activeTour=void 0}else nt.activePainting=void 0,nt.activeTour=void 0}function k(){window.history.pushState(null,"",""),void 0!==nt.activePainting?(Url.updateSearchParam("activePainting",nt.activePainting.data.painting.key),void 0!==nt.activeTour?(Url.updateSearchParam("activeTour",nt.activeTour.data.key),Url.updateSearchParam("step",nt.activeTour.step)):(Url.updateSearchParam("activeTour"),Url.updateSearchParam("step"))):(Url.updateSearchParam("activePainting"),Url.updateSearchParam("activeTour"),Url.updateSearchParam("step"))}function w(){loaded&&(H(),E())}function H(){var t=d3.transition().duration(durationVLong).ease(defaultEase);Y=Z.selectAll(".painting").data(V,function(t,n){return t.painting.key}),Y.select(".painting-container").transition(t).attr("transform",T),B(Y.select(".painting-tour-container"));var n=Y.enter().append("g").attr("class","painting transform-container").attr("id",function(t){return t.painting.key}),e=n.append("g").attr("class","painting-container"),a=e.append("g").attr("class","base-container"),i=(a.append("rect").attr("class","painting-baserect").attr("id",function(t){return"baserect-"+t.painting.key}).attr("height",paintingDisplayHeight).attr("width",function(t){return t.painting.aspectRatio*paintingDisplayHeight}),a.append("image").attr("class","painting-thumb thumb").attr("xlink:href",function(t){return t.painting.thumbUrl}).attr("width",paintingThumbHeight).attr("height",function(t){return t.painting.aspectRatio*paintingThumbHeight}).attr("transform",function(t){return"scale("+paintingThumbScale+") translate("+t.painting.aspectRatio*paintingThumbHeight+",0) rotate (90)"}),a.append("image").attr("class","painting-base").attr("xlink:href",function(t){return t.painting.baseUrl}).attr("width",paintingHeight).attr("height",function(t){return t.painting.aspectRatio*paintingHeight}).attr("transform",function(t){return"scale("+paintingScale+") translate("+t.painting.aspectRatio*paintingHeight+",0) rotate (90)"}).on("load",function(t){d3.select(this.parentNode).select(".thumb").remove()}),a.append("g").attr("class","painting-blur").append("image").attr("class","painting-blur-base").attr("xlink:href",function(t){return t.painting.blurredUrl}).attr("width",paintingBlurHeight).attr("height",function(t){return t.painting.aspectRatio*paintingBlurHeight}).attr("transform",function(t){return"scale("+paintingBlurScale+") translate("+t.painting.aspectRatio*paintingBlurHeight+",0) rotate (90)"}),e.append("g").attr("class","painting-tour-container"));i.append("g").attr("class","painting-current-step");var r=e.append("g").attr("class","painting-right-edge").attr("transform",function(t){return"translate("+t.painting.aspectRatio*paintingDisplayHeight+", 0)"}).append("g").attr("class","painting-ui-position-container");S(r),B(i),e.attr("transform",T);var o=Y.exit();o.remove();var c=n.merge(Y);c.classed("inactive",h).classed("active",g);var s=(c.select(".base-container").classed("hidden",function(t){return g(t)&&v(t)&&nt.activeTour.data.steps[nt.activeTour.step].hideMain}),c.select(".painting-blur").classed("active",function(t){return g(t)&&v(t)&&nt.activeTour.data.steps[nt.activeTour.step].blurMain}));nt.showSplash?c.select(".painting-container").on("click",null):void 0===nt.activePainting?c.select(".painting-container").on("click",M):(c.select(".painting-container").on("click",null),void 0!==nt.activeTour&&s.attr("mask","url(#cutout-mask-"+nt.activeTour.step+")"))}function S(t){var n=t.append("g").attr("class","painting-ui-container");$=X.selectAll(".painting-ui-container");var e=n.append("text").attr("class","info prevent-zoom").attr("y",2.5*q);e.append("tspan").attr("class","name header prevent-zoom reset-cursor").attr("x",0).text(function(t){return t.painting.name}),e.append("tspan").attr("class","painter prevent-zoom reset-cursor").attr("x",0).attr("dy",3*q).text(function(t){return"Attributed to "+t.painting.painter});var a=n.append("g").attr("class","painting-ui-contents-container"),i=6.5,r=i+.5,o=2;a.append("line").attr("class","divider").attr("x1",0).attr("y1",i*q).attr("x2",350).attr("y2",i*q);var c=a.append("g").attr("class","contents-entry visual-tour-button prevent-zoom").on("click",I,!0);c.append("text").text("Visual Analysis").attr("class","prevent-zoom").attr("x",0).attr("y",(r+1*o)*q)}function B(t){t.classed("active",v);var n=t.select(".painting-current-step");j(n),R(t),tt=X.selectAll("rect.outlined")}function j(t){var n=t.selectAll(".tour-object").data(function(t){if(v(t)){var n=nt.activeTour.data.steps[nt.activeTour.step].objects;return void 0!==n?n:[]}return[]},function(t){return t.key}),a=d3.transition().duration(durationMed);void 0!==nt.activeTour&&(n.select(".tour-object-base-container").transition(a).attr("transform",function(t){return"translate("+t.x+", "+t.y+")"}),n.select(".object-thumb").transition(a).attr("transform",function(t){var n=e(t);if(n.rotated)return"scale("+t.height/paintingThumbHeight+") translate("+n.aspectRatio*paintingThumbHeight+",0) rotate (90)";var a=n.aspectRatio*paintingThumbHeight;return"scale("+t.height/a+")"}),n.select(".object-base").transition(a).attr("transform",function(t){var n=e(t),a=void 0!==n.baseHeight?n.baseHeight:paintingHeight;return n.rotated?"scale("+t.height/a+") translate("+n.aspectRatio*a+",0) rotate (90)":"scale("+t.height/a+")"}),o(nt.activeTour.data.steps[nt.activeTour.step]).then(function(){var t=n.enter().append("g").attr("class","tour-object"),a=t.append("g").attr("class","tour-object-base-container").attr("transform",function(t){return"translate("+t.x+", "+t.y+")"});a.append("image").attr("class","object-thumb thumb").attr("xlink:href",function(t){return e(t).thumbUrl}).attr("width",paintingThumbHeight).attr("height",function(t){return e(t).aspectRatio*paintingThumbHeight}).attr("transform",function(t){var n=e(t);if(n.rotated)return"scale("+t.height/paintingThumbHeight+") translate("+n.aspectRatio*paintingThumbHeight+",0) rotate (90)";var a=n.aspectRatio*paintingThumbHeight;return"scale("+t.height/a+")"}),a.append("image").attr("class","object-base").attr("xlink:href",function(t){return e(t).baseUrl}).attr("width",function(t){var n=e(t),a=void 0!==n.baseHeight?n.baseHeight:paintingHeight;return n.rotated?a:a/n.aspectRatio}).attr("height",function(t){var n=e(t),a=void 0!==n.baseHeight?n.baseHeight:paintingHeight;return n.rotated?n.aspectRatio*a:a}).attr("transform",function(t){var n=e(t),a=void 0!==n.baseHeight?n.baseHeight:paintingHeight;return n.rotated?"scale("+t.height/a+") translate("+n.aspectRatio*a+",0) rotate (90)":"scale("+t.height/a+")"}).on("load",function(t){d3.select(this.parentNode).select(".thumb").remove()}),t.transition().duration(1).on("end",function(){this.classList.add("active")}),r(nt.activeTour.data)})["catch"](function(t){console.error("preload failed",t)})),n.exit().transition(a).on("start",function(){this.classList.remove("active")}).remove()}function R(t){var n=t.selectAll(".painting-step").data(function(t){return v(t)?nt.activeTour.data.steps:[]});if(n.exit().remove(),void 0!==nt.activePainting&&void 0!==nt.activeTour){var e=n.enter().append("g").attr("class",function(t,n){return"painting-step step-"+n}),a=e.append("defs").attr("class","tour-def"),i=(a.append("g").attr("class","bounds-container").attr("id",function(t,n){return"bounds-container-"+n}),e.append("use").attr("xlink:href",function(t,n){return"#bounds-container-"+n}).attr("class","bounds-display-container"),e.merge(n)),r=i.select(".bounds-container");U(r);var o=a.append("mask").attr("id",function(t,n){return"cutout-mask-"+n});o.append("use").attr("xlink:href","#baserect-"+nt.activePainting.data.painting.key).attr("fill","white"),o.append("use").attr("xlink:href",function(t,n){return"#bounds-container-"+n}).attr("fill","black")}}function U(t){var n=t.selectAll("rect").data(function(t,n){return f(t,n)?t.bounds:[]}),e=n.enter().append("rect").attr("id",function(t,n){return"bounds-"+n}).attr("x",function(t){return t.x}).attr("y",function(t){return t.y}).attr("height",function(t){return t.height}).attr("width",function(t){return t.width}).attr("stroke-width",3).attr("class","painting-bounds").classed("outlined",function(t,n){return t.framed===!0});e.transition().duration(1).on("end",function(){this.classList.add("active")}),n.exit().transition().duration(durationShort).on("start",function(){this.classList.remove("active")}).remove()}function E(){var t=d3.select("#menu-painters").selectAll("li").data(V);nt.showSplash||t.enter().append("li").append("a").text(function(t){return t.painting.painter}).merge(t).classed("active",g).on("click",M.bind(void 0)),t.exit().remove(),d3.select(".overlay").classed("active",function(){return void 0!==nt.activeTour}),void 0!==nt.activeTour&&(d3.select("#tour-header").html(function(){return decodeURI(nt.activeTour.data.steps[nt.activeTour.step].header)}),d3.select("#tour-text").html(function(){return decodeURI(nt.activeTour.data.steps[nt.activeTour.step].html)})),d3.select(".intro-page").classed("active",function(){return nt.showSplash})}function z(){nt.activePainting=void 0,nt.activeTour=void 0,nt.showSplash=!1,w(),p(),k()}function M(t,n,e){nt.activePainting={data:t,i:n,node:void 0!==this?this.parentNode:void 0},nt.activeTour=void 0,nt.showSplash=!1,w(),p(),k()}function I(){void 0!==nt.activePainting&&L(nt.activePainting.data.tours.visualTour,0)}function L(t,n){nt.activeTour={data:t,step:n},w(),p(),k()}function A(){void 0!==nt.activeTour&&nt.activeTour.step<nt.activeTour.data.steps.length-1&&(nt.activeTour.step++,w(),p(),k())}function D(){void 0!==nt.activeTour&&nt.activeTour.step>0&&(nt.activeTour.step--,w(),p(),k())}function N(t){t=t||window.event,37===t.keyCode?(D(),t.preventDefault()):39===t.keyCode&&(A(),t.preventDefault())}console.log(t);var C,W,F,V=n.mainPaintings,O=n.tourPaintings,Q=n.tourObjects,q=getRootElementFontSize(),G=d3.select(".svg-container"),J=G.node(),K=d3.select(".svg-fullscreen"),X=K.select(".root");d3.select(window).on("resize",c);var Y,Z=X.select(".paintings"),$=X.selectAll(".painting-ui-container"),tt=X.selectAll("rect.outlined"),nt={activePainting:void 0,activeTour:void 0,showSplash:!0};document.addEventListener("keydown",N),d3.select("#button-begin").on("click",z,!0),d3.select("#menu-home").on("click",z,!0),d3.select("#button-next").on("click",function(){A()},!0),d3.select("#button-prev").on("click",function(){D()},!0);var et=d3.zoom().scaleExtent([minScale,maxScale]).on("zoom",s).filter(function(){var t=void 0!==nt.activePainting&&!event.button&&!event.target.classList.contains("prevent-zoom");return t});K.call(et),P(),c(),i().then(function(){loaded=!0,window.onpopstate=function(){P(),w(),p()},w(),p()})});