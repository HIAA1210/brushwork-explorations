"use strict";function getRootElementFontSize(){return parseFloat(getComputedStyle(document.documentElement).fontSize)}var paintingHeight=2048,paintingScale=.5,paintingDisplayHeight=paintingHeight*paintingScale,paintingThumbHeight=512,paintingThumbScale=paintingDisplayHeight/paintingThumbHeight,paintingBlurHeight=32,paintingBlurScale=paintingDisplayHeight/paintingBlurHeight,paintingMargin=160,paintingCascadeLength=944,paintingUIStaticWidthPadding=32,paintingUIWidthPadding=32,zoomTourMargin=32,tourBoundsWidth=3,translateExtentBuffer=256,translateExtentTourBuffer=1024,minScale=.05,maxScale=2,durationShort=500,durationMed=750,durationLong=1e3,durationVLong=2e3,defaultEase=d3.easeCubicInOut,loaded=!1;d3.json("assets/json/paintings.json",function(t){function n(t){switch(t.type){case"painting":return F[t.key];case"crop":return V[t.key]}}function e(t,n){return console.log(t),new Promise(function(e,a){if(t.loaded)e();else{var i=new Image,r=new Image,o=void 0!==t.blurredUrl;if(i.onload=function(){t.aspectRatio=i.height/i.width,t.loaded=!0,e(),r.src=t.baseUrl},i.onerror=i.onabort=function(){console.error("failed to preload thumbnail",t),a(i)},r.onerror=r.onabort=function(){console.error("failed to preload base",t),a(i)},i.src=t.thumbUrl,o){var c=new Image;c.onerror=c.onabort=function(){console.error("failed to preload blurred",t),a(c)},c.src=t.blurredUrl}n||e()}})}function a(){for(var t=[],n=0;n<W.length;n++)t.push(e(W[n].painting,!0));return Promise.all(t)}function i(t){if(t.loaded)return Promise.resolve();for(var a=[],i=0;i<t.steps.length;i++){var r=t.steps[i];if(void 0!==r.objects)for(var o=r.objects.length,c=0;c<o;c++)"painting"!==r.objects[c].type&&"crop"!==r.objects[c].type||a.push(e(n(r.objects[c]),!0))}return Promise.all(a).then(function(){t.loaded=!0})}function r(t){if(t.loaded)return Promise.resolve();var a=[];if(void 0!==t.objects)for(var i=t.objects.length,r=0;r<i;r++)console.log(r,t.objects[r]),"painting"!==t.objects[r].type&&"crop"!==t.objects[r].type||a.push(e(n(t.objects[r]),!0));return Promise.all(a).then(function(){t.loaded=!0})}function o(){var t=q.getBoundingClientRect();C=t.width,N=t.height,$.showSplash&&l()}function c(){J.attr("transform",d3.event.transform),Y.attr("transform","scale("+1/d3.event.transform.k+") translate(16, 0)"),Z.attr("stroke-width",tourBoundsWidth/d3.event.transform.k)}function s(t,n,e){function a(){return d3.zoomIdentity.scale(d).translate(l,p)}var i=d3.transition().duration(durationLong).ease(defaultEase),r=this.getBBox(),o=r.width,c=r.height,s=r.x+r.width/2,u=r.y+r.height/2,d=Math.max(minScale,Math.min(maxScale,1/Math.max(o/C,c/N))),l=C/2/d-s,p=N/2/d-u;G.transition(i).call(tt.transform,a)}function u(t,n,e){function a(){return d3.zoomIdentity.scale(d).translate(g,h)}var i=d3.transition().duration(durationLong).ease(defaultEase),r=this.getBBox(),o=d3.select(this).select(".base-container").node().getBBox(),c=d3.select(this).select(".painting-ui-container").node().getBBox(),s=o.width,u=o.height,d=Math.max(minScale,Math.min(maxScale,1/(u/N))),l=r.x+s+c.width/d+2.5*paintingUIWidthPadding,p=r.y+u/2,g=C/d-l,h=N/2/d-p;G.transition(i).call(tt.transform,a)}function d(t,n,e){function a(){return d3.zoomIdentity.scale(l).translate(p,g)}var i=d3.transition().duration(durationLong).ease(defaultEase),r=this.parentNode.parentNode.parentNode.getBBox(),o=this.getBBox(),c=o.width,s=o.height,u=o.x+o.width/2+r.x,d=o.y+o.height/2+r.y,l=Math.max(minScale,Math.min(maxScale,1/Math.max(c/(C-2*zoomTourMargin),s/(N-2*zoomTourMargin)))),p=C/2/l-u,g=N/2/l-d;G.transition(i).call(tt.transform,a)}function l(){if(loaded)if(void 0===$.activePainting)s.bind(G.select("#frame-splash").node())();else{var t=T().getBBox(),n=d3.select(T()).select(".base-container").node().getBBox();void 0===$.activeTour?tt.translateExtent([[t.x,t.y],[t.x+t.width,t.y+n.height]]):tt.translateExtent([[t.x-translateExtentTourBuffer,t.y-translateExtentTourBuffer],[t.x+t.width+translateExtentTourBuffer,t.y+t.height+translateExtentTourBuffer]]);void 0===$.activeTour?translateExtentBuffer:translateExtentTourBuffer;void 0===$.activeTour?u.bind(T())():d.bind(d3.select(x()).select(".painting-step.step-"+$.activeTour.step).node())()}}function p(t){return void 0!==$.activePainting&&t.painting.key===$.activePainting.data.painting.key}function g(t){return void 0!==$.activePainting&&t.painting.key!==$.activePainting.data.painting.key}function h(t){return void 0!==$.activeTour&&t.painting.key===$.activePainting.data.painting.key}function v(t,n){return void 0!==$.activeTour&&$.activeTour.step===n}function f(t,n){return"translate("+n*paintingCascadeLength+","+n*(paintingDisplayHeight+paintingMargin)+")"}function m(t,n){return"translate("+-d3.select(this).select(".base-container").node().getBBox().width+","+n*(paintingDisplayHeight+paintingMargin)+")"}function b(t,n){return $.showSplash?f.bind(this)(t,n):m.bind(this)(t,n)}function T(){if(void 0===$.activePainting.node&&($.activePainting.node=J.select("#"+$.activePainting.data.painting.key).node(),null===$.activePainting.node))throw void 0===$.activePainting.node,"getActivePaintingNode(): Could not find active painting node";return $.activePainting.node}function x(){if(void 0===$.activeTour.node&&($.activeTour.node=d3.select(T()).select(".painting-tour-container").node(),null===$.activeTour.node))throw void 0===$.activeTour.node,"getActiveTourNode: Could not find active tour node";return $.activeTour.node}function y(){var t=Url.parseQuery(),n=t.activePainting;if(n){var e=_.find(W,function(t){return t.painting.key===n});if(void 0!==e){$.showSplash=!1,$.activePainting={data:e};var a=t.activeTour;if(a){var i=_.find($.activePainting.data.tours,function(t){return t.key===a});if(void 0!==i){$.activeTour={data:i,step:0};var r=parseInt(t.step,10);!isNaN(r)&&r>=0&&r<$.activeTour.data.steps.length&&($.activeTour.step=r)}}}}}function P(){void 0!==$.activePainting?(Url.updateSearchParam("activePainting",$.activePainting.data.painting.key),void 0!==$.activeTour?(Url.updateSearchParam("activeTour",$.activeTour.data.key),Url.updateSearchParam("step",$.activeTour.step)):(Url.updateSearchParam("activeTour"),Url.updateSearchParam("step"))):(Url.updateSearchParam("activePainting"),Url.updateSearchParam("activeTour"),Url.updateSearchParam("step"))}function k(){loaded&&(H(),U())}function H(){var t=d3.transition().duration(durationVLong).ease(defaultEase);K=X.selectAll(".painting").data(W,function(t,n){return t.painting.key}),K.select(".painting-container").transition(t).attr("transform",b),S(K.select(".painting-tour-container"));var n=K.enter().append("g").attr("class","painting transform-container").attr("id",function(t){return t.painting.key}),e=n.append("g").attr("class","painting-container"),a=e.append("g").attr("class","base-container"),i=(a.append("rect").attr("class","painting-baserect").attr("id",function(t){return"baserect-"+t.painting.key}).attr("height",paintingDisplayHeight).attr("width",function(t){return t.painting.aspectRatio*paintingDisplayHeight}),a.append("image").attr("class","painting-thumb").attr("xlink:href",function(t){return t.painting.thumbUrl}).attr("width",paintingThumbHeight).attr("height",function(t){return t.painting.aspectRatio*paintingThumbHeight}).attr("transform",function(t){return"scale("+paintingThumbScale+") translate("+t.painting.aspectRatio*paintingThumbHeight+",0) rotate (90)"}),a.append("image").attr("class","painting-base").attr("xlink:href",function(t){return t.painting.baseUrl}).attr("width",paintingHeight).attr("height",function(t){return t.painting.aspectRatio*paintingHeight}).attr("transform",function(t){return"scale("+paintingScale+") translate("+t.painting.aspectRatio*paintingHeight+",0) rotate (90)"}),a.append("g").attr("class","painting-blur").append("image").attr("class","painting-blur-base").attr("xlink:href",function(t){return t.painting.blurredUrl}).attr("width",paintingBlurHeight).attr("height",function(t){return t.painting.aspectRatio*paintingBlurHeight}).attr("transform",function(t){return"scale("+paintingBlurScale+") translate("+t.painting.aspectRatio*paintingBlurHeight+",0) rotate (90)"}),e.append("g").attr("class","painting-tour-container"));i.append("g").attr("class","painting-current-step");var r=e.append("g").attr("class","painting-right-edge").attr("transform",function(t){return"translate("+t.painting.aspectRatio*paintingDisplayHeight+", 0)"}).append("g").attr("class","painting-ui-position-container");w(r),S(i),e.attr("transform",b);var o=K.exit();o.remove();var c=n.merge(K);c.classed("inactive",g).classed("active",p);var s=(c.select(".base-container").classed("hidden",function(t){return p(t)&&h(t)&&$.activeTour.data.steps[$.activeTour.step].hideMain}),c.select(".painting-blur").classed("active",function(t){return p(t)&&h(t)&&$.activeTour.data.steps[$.activeTour.step].blurMain}));$.showSplash?c.select(".painting-container").on("click",null):void 0===$.activePainting?c.select(".painting-container").on("click",z):(c.select(".painting-container").on("click",null),void 0!==$.activeTour&&s.attr("mask","url(#cutout-mask-"+$.activeTour.step+")"))}function w(t){var n=t.append("g").attr("class","painting-ui-container");Y=J.selectAll(".painting-ui-container");var e=n.append("text").attr("class","info prevent-zoom").attr("y",2.5*O);e.append("tspan").attr("class","name header prevent-zoom reset-cursor").attr("x",0).text(function(t){return t.painting.name}),e.append("tspan").attr("class","painter prevent-zoom reset-cursor").attr("x",0).attr("dy",3*O).text(function(t){return"Attributed to "+t.painting.painter});var a=n.append("g").attr("class","painting-ui-contents-container"),i=6.5,r=i+.5,o=2;a.append("line").attr("class","divider").attr("x1",0).attr("y1",i*O).attr("x2",350).attr("y2",i*O);var c=a.append("g").attr("class","contents-entry visual-tour-button prevent-zoom").on("click",M,!0);c.append("text").text("Visual Analysis").attr("class","prevent-zoom").attr("x",0).attr("y",(r+1*o)*O)}function S(t){t.classed("active",h);var n=t.select(".painting-current-step");B(n),j(t),Z=J.selectAll("rect.outlined")}function B(t){var e=t.selectAll(".tour-object").data(function(t){if(h(t)){var n=$.activeTour.data.steps[$.activeTour.step].objects;return void 0!==n?n:[]}return[]},function(t){return t.key}),a=d3.transition().duration(durationMed);void 0!==$.activeTour&&(e.select(".tour-object-base-container").transition(a).attr("transform",function(t){return"translate("+t.x+", "+t.y+")"}),e.select(".object-thumb").transition(a).attr("transform",function(t){var e=n(t);if(e.rotated)return"scale("+t.height/paintingThumbHeight+") translate("+e.aspectRatio*paintingThumbHeight+",0) rotate (90)";var a=e.aspectRatio*paintingThumbHeight;return"scale("+t.height/a+")"}),e.select(".object-base").transition(a).attr("transform",function(t){var e=n(t),a=void 0!==e.baseHeight?e.baseHeight:paintingHeight;return e.rotated?"scale("+t.height/a+") translate("+e.aspectRatio*a+",0) rotate (90)":"scale("+t.height/a+")"}),r($.activeTour.data.steps[$.activeTour.step]).then(function(){var t=e.enter().append("g").attr("class","tour-object"),a=t.append("g").attr("class","tour-object-base-container").attr("transform",function(t){return"translate("+t.x+", "+t.y+")"});a.append("image").attr("class","object-thumb").attr("xlink:href",function(t){return n(t).thumbUrl}).attr("width",paintingThumbHeight).attr("height",function(t){return n(t).aspectRatio*paintingThumbHeight}).attr("transform",function(t){var e=n(t);if(e.rotated)return"scale("+t.height/paintingThumbHeight+") translate("+e.aspectRatio*paintingThumbHeight+",0) rotate (90)";var a=e.aspectRatio*paintingThumbHeight;return"scale("+t.height/a+")"}),a.append("image").attr("class","object-base").attr("xlink:href",function(t){return n(t).baseUrl}).attr("width",function(t){var e=n(t),a=void 0!==e.baseHeight?e.baseHeight:paintingHeight;return e.rotated?a:a/e.aspectRatio}).attr("height",function(t){var e=n(t),a=void 0!==e.baseHeight?e.baseHeight:paintingHeight;return e.rotated?e.aspectRatio*a:a}).attr("transform",function(t){var e=n(t),a=void 0!==e.baseHeight?e.baseHeight:paintingHeight;return e.rotated?"scale("+t.height/a+") translate("+e.aspectRatio*a+",0) rotate (90)":"scale("+t.height/a+")"}),t.transition().duration(1).on("end",function(){this.classList.add("active")}),i($.activeTour.data)})["catch"](function(t){console.error("preload failed",t)})),e.exit().transition(a).on("start",function(){this.classList.remove("active")}).remove()}function j(t){var n=t.selectAll(".painting-step").data(function(t){return h(t)?$.activeTour.data.steps:[]});if(n.exit().remove(),void 0!==$.activePainting&&void 0!==$.activeTour){var e=n.enter().append("g").attr("class",function(t,n){return"painting-step step-"+n}),a=e.append("defs").attr("class","tour-def"),i=(a.append("g").attr("class","bounds-container").attr("id",function(t,n){return"bounds-container-"+n}),e.append("use").attr("xlink:href",function(t,n){return"#bounds-container-"+n}).attr("class","bounds-display-container"),e.merge(n)),r=i.select(".bounds-container");R(r);var o=a.append("mask").attr("id",function(t,n){return"cutout-mask-"+n});o.append("use").attr("xlink:href","#baserect-"+$.activePainting.data.painting.key).attr("fill","white"),o.append("use").attr("xlink:href",function(t,n){return"#bounds-container-"+n}).attr("fill","black")}}function R(t){var n=t.selectAll("rect").data(function(t,n){return v(t,n)?t.bounds:[]}),e=n.enter().append("rect").attr("id",function(t,n){return"bounds-"+n}).attr("x",function(t){return t.x}).attr("y",function(t){return t.y}).attr("height",function(t){return t.height}).attr("width",function(t){return t.width}).attr("stroke-width",3).attr("class","painting-bounds").classed("outlined",function(t,n){return t.framed===!0});e.transition().duration(1).on("end",function(){this.classList.add("active")}),n.exit().transition().duration(durationShort).on("start",function(){this.classList.remove("active")}).remove()}function U(){var t=d3.select("#menu-painters").selectAll("li").data(W);t.enter().append("li").append("a").text(function(t){return t.painting.painter}).merge(t).classed("active",p).on("click",z.bind(void 0)),d3.select(".overlay").classed("active",function(){return void 0!==$.activeTour}),void 0!==$.activeTour&&(d3.select("#tour-header").html(function(){return decodeURI($.activeTour.data.steps[$.activeTour.step].header)}),d3.select("#tour-text").html(function(){return decodeURI($.activeTour.data.steps[$.activeTour.step].html)})),d3.select(".intro-page").classed("active",function(){return $.showSplash})}function E(){$.activePainting=void 0,$.activeTour=void 0,$.showSplash=!1,k(),l(),P()}function z(t,n,e){$.activePainting={data:t,i:n,node:void 0!==this?this.parentNode:void 0},$.activeTour=void 0,$.showSplash=!1,k(),l(),P()}function M(){void 0!==$.activePainting&&L($.activePainting.data.tours.visualTour,0)}function L(t,n){$.activeTour={data:t,step:n},k(),l(),P()}function A(){void 0!==$.activeTour&&$.activeTour.step<$.activeTour.data.steps.length-1&&($.activeTour.step++,k(),l(),P())}function I(){void 0!==$.activeTour&&$.activeTour.step>0&&($.activeTour.step--,k(),l(),P())}function D(t){t=t||window.event,37===t.keyCode?(I(),t.preventDefault()):39===t.keyCode&&(A(),t.preventDefault())}var C,N,W=t.mainPaintings,F=t.tourPaintings,V=t.tourObjects,O=getRootElementFontSize(),Q=d3.select(".svg-container"),q=Q.node(),G=d3.select(".svg-fullscreen"),J=G.select(".root");d3.select(window).on("resize",o);var K,X=J.select(".paintings"),Y=J.selectAll(".painting-ui-container"),Z=J.selectAll("rect.outlined"),$={activePainting:void 0,activeTour:void 0,showSplash:!0};document.addEventListener("keydown",D),d3.select("#button-begin").on("click",E,!0),d3.select("#menu-home").on("click",E,!0),d3.select("#button-next").on("click",function(){A()},!0),d3.select("#button-prev").on("click",function(){I()},!0);var tt=d3.zoom().scaleExtent([minScale,maxScale]).on("zoom",c).filter(function(){var t=void 0!==$.activePainting&&!event.button&&!event.target.classList.contains("prevent-zoom");return t});G.call(tt),y(),a().then(function(){loaded=!0,k(),l()}),o()});